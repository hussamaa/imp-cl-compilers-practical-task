---

## Finding bugs in OpenCL compilers

<br> 

Hussama Ismail 
<hussama.ismail@gmail.com>

---

### Bugs in OpenCL compilers? 

<br> 

* **Yes, they do exist**. This work was already done before by Alastair Donaldson and his Ph.D. students;
* Execute the **same approach** trying to find bugs in **mainstream compilers**.

---

### Tools 

<br> 

* **CLSmith**: a random generator of OpenCL C programs (based on CSmith); 
* **clreduce**: automate reducer for OpenCL (based on creduce).

+++

### Auxiliary Scripts 

<br> 

1. **generate-clsmith-kernels.sh**: a script for multiple OpenCL kernel generation using CLSmith;
2. **run-clsmith-kernels.sh**: a script for running all CLSMith kernels inside a folder;
3. **evaluate-results.sh**: a script for evaluating all log files generated.

---

### Experimental Evaluation 

<br> 

* **500** random kernels were generated;
* compiled (i) **with** and (ii) **without** optimization (1000 test cases);
* timeout of 60 seconds;
* CPU i7-3517U @ 1.90GHz, 8GB, Ubuntu 17.10 x86-64;
* Intel OpenCL SDK v1.2.

+++

### i) with optimizations:

<br> 

* total of kernels: **500**;
* **56** timeouts (**11**%);
* **283** executions without problems (**57**%) 
  * (it doesn't mean that the result is correct);
* **161** failures (**32**%);
  * compiler crash: **44** *(27%)*;
  * out of resource (OpenCL): **98** *(61%)*;
  * other errors (OpenCL): **19** *(12%)*.
  
+++

### ii) without optimizations:

<br> 

* total of kernels: **500**;
* **55** timeouts (**11**%);
* **296** executions without problems (**59**%);
* **149** failures (**30**%);
  * compiler crash: **6** *(4%)*;
  * out of resource (OpenCL): **124** *(83%)*;
  * other errors (OpenCL): **19** *(13%)*.
  
+++

### Important to note:

<br> 

* **11**% of the benchmarks were timeout;
* The non-optimized set of benchmarks shown **4%** more executions without problems;
* **6%** of the optimized kernels that executed without problems produced different results if compared to their non-optimized version;

+++

### Important to note (II):

<br> 

* the optimized benchmarks shown **7**% more failures;
  * an increase of **86**% in the number of failures related to **compiler crash**;

<br>

* The non-optimized benchmarks shown **20%** more failures related to **out of resources**.

---

### Mission II - Identifying the Bug

<br>

* Check if I would be able to expose the same bug in a small program;
* I choose the benchmark (kernel-XX.c)
  * no compilation problem for its non-optimized version;

<br>

* Programs generated by CLSmith are valid but they don't follow any logic.

+++

### Mission II - The Bug is...

<br>

```
l_344 = (
  safe_lshift_func_uint16_t_u_u(
    (safe_mod_func_int16_t_s_s(
      (safe_add_func_uint8_t_u_u(
        ((safe_sub_func_uint8_t_u_u(
          (((p_18, ((l_234.x = (l_368 = (( * l_329) |= ((void * ) 0 != & p_554 - > g_256)))) < (((p_18 != (p_19 || (l_369 &= l_354.w))) >
            ((safe_div_func_int16_t_s_s(((VECTOR(int16_t, 2))(rhadd(((VECTOR(int16_t, 8))((((FAKE_DIVERGE(p_554 - > local_2_offset, get_local_id(2), 10) < (((((p_554 - > g_373[1] = l_372) != (FAKE_DIVERGE(p_554 - > global_1_offset,
                  get_global_id(1), 10), (void * ) 0)) >
                ((VECTOR(int32_t, 16))(((VECTOR(int32_t, 4))((p_554 - > g_25, l_374), l_374, (-1 L), (-1 L))).yxyyyyzwzxwywzwz)).s7) <= p_18) != p_554 - > g_86.f1)),
              l_354.y) <= p_18), 0x554D L, ((VECTOR(int16_t, 4))(0x0BAF L)), 0 L, 0x796B L)).s76, ((VECTOR(int16_t, 2))(0x2982 L))))).lo, l_344)) == 0x7F4C L)
          ) <= 0x11 L))) != 0x3590 L) && 0 UL), 0x46 L)) >= p_19), p_554 - > g_330.s6)), 0xB56D L)), p_19));
```

+++

### Mission II - Identifying the Bug

<br>

# FAILED!

<br>

* more time of "debbuging" is necessary.

---

Thank you for your attention!

<br>

All logs and scripts are available on GitHub.
